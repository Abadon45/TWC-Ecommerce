{% extends "base-shop.html" %}
{% load static %}
{% load currency_filters %}

{% block title %} {{ title }} {% endblock %}

{% block content %}

    <div class="shop-checkout2 twc-checkout py-100 mobile-width">
        <div class="container">
            <div class="shop-checkout-wrap">
                <div class="row">
                    {% if not default_address %}
                        <div class="col-sm-7 col-md-8 mb-20">
                            <div class="shop-checkout-step">
                                <nav class="nav checkout-step-list nav-pills nav-justified mb-3" id="shopCheckout"
                                     role="tablist">
                                    <a href="#" class="nav-link active done" id="step1-tab" data-bs-toggle="pill"
                                       data-bs-target="#step1" type="button" role="tab" aria-controls="step1"
                                       aria-selected="true">
                                        <span class="step-count">1</span>
                                        SHIPPING ADDRESS
                                    </a>
                                    <a href="#" class="nav-link" id="step2-tab" data-bs-toggle="pill"
                                       data-bs-target="#step2"
                                       type="button" role="tab" aria-controls="step2" aria-selected="false">
                                        <span class="step-count">2</span>
                                        PAYMENT
                                    </a>
                                </nav>
                                <div class="tab-content" id="pills-tabContent">
                                    <div class="tab-pane fade show active" id="step1" role="tabpanel"
                                         aria-labelledby="step1-tab" tabindex="0">
                                        <div class="shop-checkout-form">
                                            {% include 'cart/address-form.html' %}
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="step2" role="tabpanel" aria-labelledby="step2-tab"
                                         tabindex="0">
                                        {% if dev_domain and dev_admin %}
                                            <div class="shop-checkout-payment">
                                                <ul class="nav nav-pills mb-3" id="payment-tabs" role="tablist">
                                                    <li class="nav-item" role="presentation">
                                                        <a class="nav-link active" id="xendit-tab" data-bs-toggle="pill"
                                                           data-bs-target="#xendit" type="button" role="tab"
                                                           aria-controls="xendit" aria-selected="true">
                                                            &nbsp;&nbsp;&nbsp;<span>Pay With Xendit</span>
                                                        </a>
                                                    </li>
                                                    <li class="nav-item" role="presentation">
                                                        <a class="nav-link" id="cod-tab" data-bs-toggle="pill"
                                                           data-bs-target="#cod" type="button" role="tab"
                                                           aria-controls="cod" aria-selected="false" tabindex="-1">
                                                            <div class="checkout-payment-img cod">
                                                                <img src="assets/img/payment/cod-3.svg" alt="">
                                                            </div>
                                                            &nbsp;&nbsp;&nbsp;<span>Cash On Delivery</span>
                                                        </a>
                                                    </li>
                                                </ul>

                                                <div class="tab-content" id="payment-tabContent">
                                                    <div class="tab-pane fade show active" id="xendit" role="tabpanel"
                                                         aria-labelledby="xendit-tab" tabindex="0">
                                                        <!-- Xendit Payment Information -->
                                                        <div class="shop-checkout-form cod">
                                                            <form class="payment-form" action="#" method="get">
                                                                <div class="row">
                                                                    <div class="col-lg-12">
                                                                        <div class="form-check">
                                                                            <label class="form-check-label"
                                                                                   for="cod">
                                                                                Xendit
                                                                                <span>
                                                                                    To enhance your shopping experience,
                                                                                    we use Xendit as our payment gateway.
                                                                                    With Xendit, you can pay securely using various methods,
                                                                                    including credit cards such as Visa and MasterCard,
                                                                                    or popular e-wallets like GCash.
                                                                                    Enjoy fast and hassle-free transactions,
                                                                                    and rest assured that your payment information is secure.
                                                                                </span>
                                                                            </label>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                    <div class="tab-pane fade" id="cod" role="tabpanel"
                                                         aria-labelledby="cod-tab" tabindex="0">
                                                        <!-- COD Payment Information -->
                                                        <div class="shop-checkout-form cod">
                                                            <form class="payment-form" action="#" method="get">
                                                                <div class="row">
                                                                    <div class="col-lg-12">
                                                                        <div class="form-check">
                                                                            <label class="form-check-label" for="cod">
                                                                                Cash On Delivery
                                                                                <span>Please read our <a
                                                                                        href="{% url 'terms' %}">Terms And
                                                                            Conditions</a> for cash on delivery.</span>
                                                                            </label>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="shop-checkout-payment">
                                                <div class="tab-content" id="pills-tabContent">
                                                    <div class="tab-pane fade show active" id="pills-1" role="tabpanel"
                                                         aria-labelledby="pills-tab-1" tabindex="0">
                                                        <div class="shop-checkout-form cod">
                                                            <form class="payment-form" action="#" method="get">
                                                                <div class="row">
                                                                    <div class="col-lg-12">
                                                                        <div class="form-check">
                                                                            <label class="form-check-label" for="cod">
                                                                                Cash On Delivery
                                                                                <span>Please read our <a
                                                                                        href="{% url 'terms' %}">Terms And
                                                                            Conditions</a> for cash on delivery.</span>
                                                                            </label>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-5 col-md-4">
                            <div class="shop-cart-summary mt-lg-0">
                                <div class="card index-card">
                                    <div class="card-header">
                                        <h3>CART SUMMARY</h3>
                                    </div>
                                    <div class="card-body">
                                        {% for shop, data in orders.items %}
                                            <ul class="bordered-bottom {% if not forloop.last %} mb-20 {% endif %}">
                                                <li>
                                                    <h6>
                                                        Shop:
                                                        {% if shop == "sante" %}
                                                            Sante International
                                                        {% endif %}
                                                        {% if shop == "mood" %}
                                                            Mood Timepieces
                                                        {% endif %}
                                                        {% if shop == "chingu" %}
                                                            Chingu
                                                        {% endif %}
                                                    </h6>
                                                </li>
                                                <li>
                                                    <div class="shop-cart-coupon">
                                                        <div class="form-group">
                                                            <input type="text" class="form-control"
                                                                   placeholder="Your Coupon Code">
                                                            <button class="theme-btn custom-btn-1" type="submit">APPLY
                                                            </button>
                                                        </div>
                                                    </div>
                                                </li>
                                                </li>
                                                <li>Order Sub Total: <span>{{ data.subtotal|currency }}</span>
                                                </li>
                                                {% if order.discount %}
                                                    <li class="list-discount">Discount:
                                                        <span>{{ data.discount|currency }}</span></li>
                                                {% else %}
                                                    <li class="list-discount">Discount: <span>No discount applied</span>
                                                    </li>
                                                {% endif %}
                                                <li id="shipping_fee_{{ shop }}" class="pb15">
                                                    Shipping fee:
                                                    <span>
                                                        {% if FIXED_SHIPPING_FEE == 0 %}
                                                            Calculated at next step
                                                        {% else %}
                                                            {{ FIXED_SHIPPING_FEE|currency }}
                                                        {% endif %}
                                                    </span>
                                                </li>
                                                <li class="shop-cart-total"><strong>Order Total:</strong>
                                                    <span id="order-total-{{ shop }}">{{ data.cod_amount|currency }}</span>
                                                </li>
                                            </ul>
                                        {% endfor %}
                                        <h4 class="cart-total mt-3">
                                            <strong>
                                                <span class="cart-label">Cart Total:</span>
                                                <span class="cart-value"
                                                      id="total-payment">{{ cart_total|currency }}</span>
                                            </strong>
                                        </h4>
                                        <div class="text-end mt-40 checkoutBtn">
                                            <form id="checkoutForm" class="form" method="GET"
                                                  action="{% url 'cart:submit_checkout' %}">
                                                <button type="submit" class="theme-btn checkout-btn"
                                                        data-referrer-id="{{ referred_by }}"
                                                        data-username="{{ current_user }}"
{#                                                        onclick="checkoutBtn(event)" #}
                                                        hidden>
                                                    CHECKOUT NOW
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    {% endif %}
                    {% if is_authenticated %}
                        {% if default_address %}
                            <div class="col-md-8">
                                <div class="row">
                                    <div class="col-lg-12">
                                        <div class="address-area">

                                            <h6 class="mb-2">Delivery Address</h6>

                                            <p class="selected_address">{{ default_address.first_name }}
                                                {{ default_address.last_name }}
                                                {{ default_address.phone }}</p>
                                            <div class="change-address row mb-20">
                                                <div class="col-md-10 col-10">
                                                    <p class="address_details">{{ default_address.line1 }} Brgy.
                                                        {{ default_address.barangay }},
                                                        {{ default_address.city }}, {{ default_address.province }},
                                                        {{ default_address.postcode }} </p>
                                                </div>
                                                <div class="col-2 d-flex justify-content-end">
                                                    <span class="is_default">Default</span>
                                                </div>
                                                <div class="row">
                                                    <div class="col-lg-1">
                                                        <button type="button" class="change-address-btn">Change</button>
                                                    </div>
                                                </div>
                                                {% include 'cart/change-address-modal.html' %}
                                                {% include 'cart/add-address-modal.html' %}
                                                {% include 'cart/edit-address-modal.html' %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-12">
                                        <div class="shop-cart-summary payment-area" style="margin-left: 0!important;">
                                            <h5>Mode of Payment</h5>
                                            <label class="form-check-label" for="cod">
                                                <h6>Cash On Delivery</h6>
                                                <p>Please read our <a href="{% url 'terms' %}">Terms And
                                                    Conditions</a> for cash on delivery.</p>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-lg-12 mt-20 continue-shopping mobile-hidden">
                                        <a href="{% url 'shop:shop' %}" type="button" class="theme-btn theme-btn2">CONTINUE
                                            SHOPPING</a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="shop-cart-summary user-logged" style="margin-left: 0!important;">
                                    <div class="card index-card">
                                        <div class="card-header">
                                            <h3>CART SUMMARY</h3>
                                        </div>
                                        <div class="card-body">
                                            {% for order in orders %}
                                                <ul class="bordered-bottom {% if not forloop.last %} mb-20 {% endif %}">
                                                    <li>
                                                        <h6>
                                                            Shop:
                                                            {% if order.supplier == "sante" %}
                                                                Sante International
                                                            {% endif %}
                                                            {% if order.supplier == "mood" %}
                                                                Mood Timepieces
                                                            {% endif %}
                                                            {% if order.supplier == "chingu" %}
                                                                Chingu
                                                            {% endif %}
                                                            {% if order.supplier == None %}
                                                                Promo Bundle
                                                            {% endif %}
                                                        </h6>
                                                    </li>
                                                    <li>
                                                        <div class="shop-cart-coupon">
                                                            <div class="form-group">
                                                                <input type="text" class="form-control"
                                                                       placeholder="Your Coupon Code">
                                                                <button class="theme-btn custom-btn-1" type="submit">
                                                                    APPLY
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </li>
                                                    <li>Order: <span>{{ order.order_id }}</span></li>
                                                    <li>Order Sub Total:
                                                        <span id="order-subtotal-{{ order.order_id }}">{{ order.subtotal|currency }}</span>
                                                    </li>
                                                    {% if order.discount %}
                                                        <li class="list-discount">Discount:
                                                            <span>{{ order.discount|currency }}</span></li>
                                                    {% else %}
                                                        <li class="list-discount">Discount:
                                                            <span>No discount applied</span></li>
                                                    {% endif %}
                                                    <li class="list-shipping">Shipping Fee:
                                                        <span>{{ order.shipping_fee|currency }}</span></li>
                                                    <li class="shop-cart-total">Order Total: <span
                                                            id="order-total-{{ order.order_id }}">
                                                    {% if order.cod_amount %}
                                                        {{ order.cod_amount|currency }}
                                                    {% else %}
                                                        {{ order.subtotal|currency }}
                                                    {% endif %}
                                                </span></li>
                                                </ul>
                                            {% endfor %}
                                            <h4 class=" cart-total mt-3 py20">
                                                <strong>
                                                    <span class="cart-label">Cart Total:</span>
                                                    <span class="cart-value"
                                                          id="total-payment">{{ total_payment|currency }}</span>
                                                </strong>
                                            </h4>
                                            <div class="col-lg-12 shop-checkout-form mt-20"
                                                 style="padding: 0!important; border: none!important; ">
                                                <form id="checkoutForm" class="form" method="GET"
                                                      action="{% url 'cart:submit_checkout' %}">
                                                    <button type="submit" class="theme-btn checkout-btn"
{#                                                            onclick="checkoutBtn(event)"#}
                                                            data-referrer-id="{{ referred_by }}">
                                                        CHECKOUT NOW
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-12 mt-20 continue-shopping mobile-only">
                                        <a href="{% url 'shop:shop' %}" type="button" class="theme-btn theme-btn2">CONTINUE
                                            SHOPPING</a>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                    {% if not is_authenticated or not default_address %}
                        <div class="mobile-only">
                            <div class="d-flex justify-content-between align-items-center dummy-submit">
                                <a href="{% url 'cart:cart' %}" type="button" class="theme-btn">CONTINUE SHOPPING</a>
                                <input type="hidden" name="submit_type" value="shipping">
                                <button type="button" class="theme-btn" onclick="submitForm()">NEXT STEP</button>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

{% endblock %}
{% block extra_js %}
    <script>
        $(document).ready(function () {
            $('.checkout-btn').on('click', function (event) {
                // Get the active tab's ID
                var activePaymentMethod = $('#payment-tabs .nav-link.active').attr('id');

                // Determine the payment method based on the active tab
                var paymentMethod = activePaymentMethod === 'xendit-tab' ? 'xendit' : 'cod';

                // Log the selected payment method
                console.log('Selected Payment Method:', paymentMethod);

                checkoutBtn(event, paymentMethod);
            });
        });
    </script>
    <script>
        // dummy button for submitting form
        function submitForm() {
            $('#addUserData').click();
        }

        $('.dummy-submit button').click(submitForm);

        function checkoutBtn(event, paymentMethod) {
            event.preventDefault();
            var referrerId = $(event.currentTarget).data('referrer-id');

            if (referrerId === "None" || referrerId === '') {
                Swal.fire({
                    icon: 'warning',
                    title: 'REQUIRED INFORMATION',
                    text: 'To complete checkout, please input the USERNAME of your sponsor.',
                    input: 'text',
                    inputPlaceholder: 'Enter username',
                    showCancelButton: true,
                    confirmButtonText: 'Submit',
                    cancelButtonText: 'Cancel',
                    preConfirm: (username) => {
                        if (!username) {
                            Swal.showValidationMessage('Username is required!');
                        } else if (username.toLowerCase() === 'None') {
                            Swal.showValidationMessage('Username is required!');
                        } else if (username.toLowerCase() === 'admin') {
                            Swal.showValidationMessage('You cannot use this username!');
                        } else {
                            return username;
                        }
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        var username = result.value;
                        saveReferrerUsername(username, paymentMethod);
                    }
                });
            } else {
                var username = referrerId;
                saveReferrerUsername(username, paymentMethod);
            }
        }

        function saveReferrerUsername(username, paymentMethod) {
            const url = `{% url "cart:submit_checkout" %}?username=${encodeURIComponent(username)}`;
            $.ajax({
                url: url,
                method: 'GET',
                data: {
                    username: username,
                    payment_method: paymentMethod,
                },
                success: function (response) {
                    // Show the thank you alert
                    Swal.fire({
                        title: 'Thank You for Your Order!',
                        text: 'Now completing checkout...',
                        icon: 'success',
                        didOpen: () => {
                            Swal.showLoading(); // Show loading spinner
                        }
                    });

                    // After a short delay, submit the form
                    setTimeout(() => {
                        $('#checkoutForm').submit();
                    }, 2000); // Adjust the delay time as needed
                },
                error: function (xhr, status, error) {
                    console.error('Error saving referrer username:', error);
                    var responseData = JSON.parse(xhr.responseText);
                    var errorMessage = responseData.error;
                    Swal.fire({
                        title: 'Error',
                        text: errorMessage,
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            });
        }
    </script>
{% endblock %}